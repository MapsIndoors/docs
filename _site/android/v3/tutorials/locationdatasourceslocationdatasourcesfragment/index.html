<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="stylesheet" href="/assets/style.css">
    <title>Document</title>
  </head>
  <body>
    <section class="container">
      
  <nav>
    <h2>Android v3</h2>
    
    <ul class="sidebar-nav"><li class="bold"><a href="/android/v3/guides/">Guides</a><ul><li><a href="/android/v3/tutorials/locationdatasourcespeoplelocationdatasource/">Creating your own Location Data Source - Part 1</a></li>
<li><a href="/android/v3/tutorials/locationdatasourcesbatterieslocationdatasource/">Creating your own Location Data Source - Part 2</a></li>
<li class="active"><a href="/android/v3/tutorials/locationdatasourceslocationdatasourcesfragment/">Creating your own Location Data Source - Part 3</a></li>
<li><a href="/android/v3/tutorials/locationclusteringlocationclusteringfragment/">Work with location grouping / clustering</a></li>
<li><a href="/android/v3/tutorials/locationdetailsdemolocationdetailsfragment/">Show Location Details</a></li>
<li><a href="/android/v3/tutorials/searchmapdemosearchfragment/">Create a Search Experience with MapsIndoors - Part 1</a></li>
<li><a href="/android/v3/tutorials/searchmapdemosearchmapfragment/">Create a Search Experience with MapsIndoors - Part 2</a></li>
<li><a href="/android/v3/tutorials/showuserlocationdemopositionprovider/">Show the Blue Dot with MapsIndoors - Part 1</a></li>
<li><a href="/android/v3/tutorials/showuserlocationshowuserlocationfragment/">Show the Blue Dot with MapsIndoors - Part 2</a></li></ul></li>
<li><a href="/android/v3/changelog/">Changelog</a></li></ul>
  </nav>

      <main>
        <p>This is part 3 of the tutorial for building a custom Location Source. <a href="../locationdatasourcespeoplelocationdatasource">In Part 1 we created the People Location Source</a> and <a href="../locationdatasourcesbatterieslocationdatasource">In Part 2 we created the Batteries Location Source</a>. Now we will create a Fragment displaying a map that shows the mocked people locations and the batteries on top of a MapsIndoors map.</p>
<p>Create the class <code>LocationDataSourcesFragment</code> that extends <code>Fragment</code>:</p>
<pre><code class="language-java">public class LocationDataSourcesFragment extends Fragment {
</code></pre>
<p>Add a <code>GoogleMap</code> and a <code>MapControl</code> to the class:</p>
<pre><code class="language-java">MapControl mMapControl;
GoogleMap mGoogleMap;
</code></pre>
<p>Add other needed views for this example:</p>
<pre><code class="language-java">SupportMapFragment mMapFragment;
</code></pre>
<p>The Venue's coordinates:</p>
<pre><code class="language-java">static final LatLng VENUE_LAT_LNG = new LatLng(57.05813067, 9.95058065);
</code></pre>
<p>Location Data Sources objects:</p>
<pre><code class="language-java">PeopleLocationDataSource peopleLocationDataSource;
BatteriesLocationDataSource batteriesLocationDataSource;
</code></pre>
<p>Once the map is ready, move the camera to the venue's location and call setupMapsIndoors:</p>
<pre><code class="language-java">OnMapReadyCallback mOnMapReadyCallback = new OnMapReadyCallback() {
    @Override
    public void onMapReady( GoogleMap googleMap )
    {
        mGoogleMap = googleMap;
        mGoogleMap.moveCamera( CameraUpdateFactory.newLatLngZoom( VENUE_LAT_LNG, 13.0f ) );
        setupMapsIndoors();
    }
};
</code></pre>
<p>Create a method <code>setupMapsIndoors</code> and:</p>
<ul>
<li>Initialize MapsIndoors.</li>
<li>Set the Google API Key (used by the routing provider).</li>
<li>Set a listener on the internal location data source service. Location data is not available at the same time other data (building info, etc.) is</li>
<li>Invoke the location sources and call <code>setupMapControl</code> when ready</li>
</ul>
<pre><code class="language-java">void setupMapsIndoors() {
    final Activity context = getActivity();
    if ((context == null) || (mMapFragment == null) || (mMapFragment.getView() == null)) {
        return;
    }
    // Sets the SDK to a &quot;clean&quot; state. In most cases, this is not needed
    MapsIndoors.onApplicationTerminate();
    MapsIndoors.initialize( DemoApplication.getInstance(), getString( R.string.mi_api_key ) );
    MapsIndoors.setGoogleAPIKey( getString( R.string.google_maps_key ) );
    // Set a listener to observe for location source status changes. In this example, we need to know when locations are
    // ready (MPLocationSourceStatus.AVAILABLE) so we can start updating/animating them
    MapsIndoors.addLocationSourceOnStatusChangedListener( locationSourceOnStatusChangedListener );
    setupLocationDataSources( error -&gt; setupMapControl() );
}
</code></pre>
<p>Create a method <code>setupLocationDataSources</code>:</p>
<ul>
<li>Instantiate <code>PeopleLocationDataSource</code> and <code>BatteriesLocationDataSource</code></li>
<li>Set/register the location sources</li>
</ul>
<pre><code class="language-java">void setupLocationDataSources( @NonNull OnResultReadyListener listener ) {
    Set&lt;MPLocationSource&gt; locationDataSources = new HashSet&lt;&gt;( 2 );
    peopleLocationDataSource = new PeopleLocationDataSource();
    locationDataSources.add( peopleLocationDataSource );
    batteriesLocationDataSource = new BatteriesLocationDataSource();
    locationDataSources.add( batteriesLocationDataSource );
    MapsIndoors.setLocationSources( locationDataSources.toArray( new MPLocationSource[0] ), error -&gt; {
        final FragmentActivity context = getActivity();
        if (context != null) {
            context.runOnUiThread(() -&gt; {
                if (error != null) {
                    Toast.makeText(context, &quot;Error occurred when setting the Datasources&quot;, Toast.LENGTH_SHORT).show();
                }
                listener.onResultReady(error);
            });
        }
    });
}
</code></pre>
<p>Create a method <code>setupMapControl</code>:</p>
<ul>
<li>Instantiate MapControl.</li>
<li>Add the custom display rules used by the location sources.</li>
<li>Initialize the <code>MapControl.init()</code> object which will synchronize the data.</li>
</ul>
<pre><code class="language-java">void setupMapControl() {
    final Activity activityContext = getActivity();
    if ((activityContext == null) || (mMapFragment == null)) {
        return;
    }
    mMapControl = new MapControl( activityContext );
    mMapControl.setGoogleMap( mGoogleMap, mMapFragment.getView() );
    mMapControl.addDisplayRule( PeopleLocationDataSource.DISPLAY_RULE );
    mMapControl.addDisplayRule( BatteriesLocationDataSource.DISPLAY_RULE );
    mMapControl.init( null );
}
</code></pre>
<p>Add <code>locationSourceOnStatusChangedListener</code>:</p>
<ul>
<li>Once location data from our custom sources becomes available, start updating them</li>
<li>Select the first floor and move the camera to the Venue's position</li>
</ul>
<pre><code class="language-java">final MPLocationSourceOnStatusChangedListener locationSourceOnStatusChangedListener = new MPLocationSourceOnStatusChangedListener() {
    @Override
    public void onStatusChanged( @NonNull MPLocationSourceStatus status, int sourceId ) {
        if ( status == MPLocationSourceStatus.AVAILABLE ) {
            final Activity context = getActivity();
            if (context != null) {
                context.runOnUiThread(() -&gt; {
                    peopleLocationDataSource.startUpdatingPositions();
                    batteriesLocationDataSource.startUpdatingIcons();
                    // Select a floor and animate the camera to the venue's position
                    mMapControl.selectFloor( 1 );
                    mGoogleMap.animateCamera( CameraUpdateFactory.newLatLngZoom( VENUE_LAT_LNG, 20f ) );
                });
            }
        }
    }
};
</code></pre>
<p>Implement the <code>onDestroyView</code> method to stop updating the location sources:</p>
<pre><code class="language-java">@Override
public void onDestroyView() {
    if (mMapControl != null) {
        peopleLocationDataSource.stopUpdatingPositions();
        batteriesLocationDataSource.stopUpdatingIcons();
        MapsIndoors.removeLocationSourceOnStatusChangedListener( locationSourceOnStatusChangedListener );
        mMapControl.onDestroy();
        MapsIndoors.onApplicationTerminate();
        MapsIndoors.initialize( DemoApplication.getInstance(), getString( R.string.mi_api_key ) );
    }
    super.onDestroyView();
}
</code></pre>
<p><a href="https://github.com/MapsIndoors/MapsIndoorsAndroid-Demo-Samples/blob/master/app/src/main/java/com/mapsindoors/locationdatasources/LocationDataSourcesFragment.java">See the sample in LocationDataSourcesFragment.java</a></p>

      </main>
    </section>
  </body>
</html>
