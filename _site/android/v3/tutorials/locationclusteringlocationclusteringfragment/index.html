<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
  </head>
  <body>
    
  <nav>
    <h2>Android v3</h2>
    
    <ul class="sidebar-nav"><li class="bold"><a href="/android/v3/guides/">Guides</a><ul><li><a href="/android/v3/tutorials/locationdatasourcespeoplelocationdatasource/">Creating your own Location Data Source - Part 1</a></li>
<li><a href="/android/v3/tutorials/locationdatasourcesbatterieslocationdatasource/">Creating your own Location Data Source - Part 2</a></li>
<li><a href="/android/v3/tutorials/locationdatasourceslocationdatasourcesfragment/">Creating your own Location Data Source - Part 3</a></li>
<li class="active"><a href="/android/v3/tutorials/locationclusteringlocationclusteringfragment/">Work with location grouping / clustering</a></li>
<li><a href="/android/v3/tutorials/locationdetailsdemolocationdetailsfragment/">Show Location Details</a></li>
<li><a href="/android/v3/tutorials/searchmapdemosearchfragment/">Create a Search Experience with MapsIndoors - Part 1</a></li>
<li><a href="/android/v3/tutorials/searchmapdemosearchmapfragment/">Create a Search Experience with MapsIndoors - Part 2</a></li>
<li><a href="/android/v3/tutorials/showuserlocationdemopositionprovider/">Show the Blue Dot with MapsIndoors - Part 1</a></li>
<li><a href="/android/v3/tutorials/showuserlocationshowuserlocationfragment/">Show the Blue Dot with MapsIndoors - Part 2</a></li></ul></li>
<li><a href="/android/v3/changelog/">Changelog</a></li></ul>
  </nav>

    <main>
      <p>This is an example of enabling and disabling location clustering on the map as well as providing custom cluster tapping behaviour and custom cluster images.</p>
<p>Create the class <code>LocationClusteringFragment</code> that extends <code>Fragment</code>:</p>
<pre><code class="language-java">public class LocationClusteringFragment extends Fragment {
</code></pre>
<p>Add a <code>GoogleMap</code> and a <code>MapControl</code> to the class:</p>
<pre><code class="language-java">MapControl mMapControl;
GoogleMap mGoogleMap;
</code></pre>
<p>Add other needed views for this example:</p>
<pre><code class="language-java">SupportMapFragment mMapFragment;
</code></pre>
<p>The Venue's coordinates:</p>
<pre><code class="language-java">static final LatLng VENUE_LAT_LNG = new LatLng( 57.05813067, 9.95058065 );
</code></pre>
<p>Once the map is ready, move the camera to the venue location and call setupMapsIndoors</p>
<pre><code class="language-java">OnMapReadyCallback mOnMapReadyCallback = new OnMapReadyCallback() {
    @Override
    public void onMapReady( GoogleMap googleMap )
    {
        mGoogleMap = googleMap;
        mGoogleMap.moveCamera( CameraUpdateFactory.newLatLngZoom( VENUE_LAT_LNG, 13.0f ) );
        setupMapsIndoors();
    }
};
</code></pre>
<p>Add a <code>locationClusterImageAdapter</code> to customize the cluster marker icons and provide their sizes:</p>
<pre><code class="language-java">MPLocationClusterImageAdapter locationClusterImageAdapter = new MPLocationClusterImageAdapter() {
    @Nullable
    @Override
    public Bitmap getImage( @NonNull String clusterId, @NonNull List&lt;MPLocation&gt; locations, @NonNull ImageSize imageSize )
    {
        final int textSize = Convert.getPixels( 15 );
        return getCircularImageWithText(
                &quot;&quot; + locations.size(),
                textSize,
                imageSize.width,
                imageSize.height
        );
    }
    @NonNull
    @Override
    public ImageSize getImageSize( @NonNull String clusterId, int count )
    {
        final int imageSizeInPixels = Convert.getPixels( 25 );
        return new ImageSize( imageSizeInPixels, imageSizeInPixels );
    }
};
</code></pre>
<p>Create a method <code>getCircularImageWithText</code> that creates the custom bitmaps for our cluster icons:</p>
<pre><code class="language-java">@NonNull
public static Bitmap getCircularImageWithText( @NonNull String text, int textSize, int width, int height )
{
    final Paint background = new Paint();
    background.setColor( Color.WHITE );
    // Now add the icon on the left side of the background rect
    final Bitmap result = Bitmap.createBitmap( width, height, Bitmap.Config.ARGB_8888 );
    final Canvas canvas = new Canvas( result );
    final int radius = width &gt;&gt; 1;
    canvas.drawCircle( radius, radius, radius, background );
    background.setColor( Color.BLACK );
    background.setStyle( Paint.Style.STROKE );
    background.setStrokeWidth( 3 );
    canvas.drawCircle( radius, radius, radius - 2, background );
    final TextPaint tp = new TextPaint();
    tp.setTextSize( textSize );
    tp.setColor( Color.BLACK );
    final Rect bounds = new Rect();
    tp.getTextBounds( text, 0, text.length(), bounds );
    final int text_height = bounds.height();
    final int text_width = bounds.width();
    final int textpos_x = (width - text_width) &gt;&gt; 1;
    final int textpos_y = (height + text_height) &gt;&gt; 1;
    canvas.drawText( text, textpos_x, textpos_y, tp );
    return result;
}
</code></pre>
<p>Create a method <code>setupMapsIndoors</code> that:</p>
<ul>
<li>Sets the API key to the desired solution.</li>
<li>Sets the Google API key (required by our routing provider).</li>
<li>Instantiates MapControl.</li>
<li>Enables clustering.</li>
<li>Sets an OnLocationClusterListener so we can handle the cluster markers click events.</li>
<li>Sets the LocationClusterImageAdapter.</li>
<li>Initializes the MapControl object which will synchronize the data.</li>
<li>When the MapControl's initialization is done, it selects a floor and animates the camera to the venue position.</li>
</ul>
<pre><code class="language-java">void setupMapsIndoors()
{
    final Activity context = getActivity();
    if( (context == null) || (mMapFragment == null) || (mMapFragment.getView() == null) )
    {
        return;
    }
    if( !MapsIndoors.getAPIKey().equalsIgnoreCase( getString( R.string.mi_api_key ) ) )
    {
        MapsIndoors.setAPIKey( getString( R.string.mi_api_key ) );
    }
    MapsIndoors.setGoogleAPIKey( getString( R.string.google_maps_key ) );
    mMapControl = new MapControl( context );
    mMapControl.setGoogleMap( mGoogleMap, mMapFragment.getView() );
    // Currently, on Android, we can enable/disable clustering
    // - via our CMS
    // - by calling MapControl.setLocationClusteringEnabled( true/false ) BEFORE invoking MapControl.init()
    // Runtime clustering enable/disable is not currently supported
    mMapControl.setLocationClusteringEnabled( true );
    // Set the custom cluster image adapter
    mMapControl.setLocationClusterImageAdapter( locationClusterImageAdapter );
    // When clicking on a cluster marker zoom in to the maximum trying to break the cluster
    mMapControl.setOnLocationClusterClickListener( ( marker, locations ) -&gt; {
        mGoogleMap.animateCamera( CameraUpdateFactory.newLatLngZoom( marker.getPosition(), 22f  ) );
        return true;
    } );
    mMapControl.init( miError -&gt; {
        if( miError == null ) {
            final Activity _context = getActivity();
            if( _context != null ) {
                mMapControl.selectFloor( 1 );
                mGoogleMap.animateCamera( CameraUpdateFactory.newLatLngZoom( VENUE_LAT_LNG, 20f ) );
            }
        }
    } );
}
</code></pre>
<p><a href="https://github.com/MapsIndoors/MapsIndoorsAndroid-Demo-Samples/blob/master/app/src/main/java/com/mapsindoors/locationclustering/LocationClusteringFragment.java">See the sample in LocationClusteringFragment.java</a></p>

    </main>
  </body>
</html>
